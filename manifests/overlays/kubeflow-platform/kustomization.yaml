apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: kubeflow
resources:
  - ../../overlays/manager
  - ../../overlays/runtimes
  - kubeflow-trainer-roles.yaml

patches:
  - path: patches/remove-namespace.yaml
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: kubeflow-trainer-controller-manager
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: kubeflow-trainer-controller-manager
        namespace: kubeflow-system
      spec:
        selector:
          matchLabels:
            app.kubernetes.io/name: trainer
            app.kubernetes.io/component: manager
            app.kubernetes.io/part-of: kubeflow
        template:
          metadata:
            labels:
              app.kubernetes.io/name: trainer
              app.kubernetes.io/component: manager
              app.kubernetes.io/part-of: kubeflow
            annotations:
              traffic.sidecar.istio.io/excludeInboundPorts: "9443"
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: jobset-controller-manager
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: jobset-controller-manager
        namespace: kubeflow-system
      spec:
        template:
          metadata:
            annotations:
              traffic.sidecar.istio.io/excludeInboundPorts: "9443"
