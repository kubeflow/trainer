#
# Copyright 2025 The Kubeflow authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

suite: Test torch-distributed-with-cache ClusterTrainingRuntime
templates:
  - templates/runtimes/data-cache/torch-distributed-with-cache.yaml
release:
  name: kubeflow-trainer
  namespace: kubeflow-trainer
tests:
  - it: Should not render ClusterTrainingRuntime when dataCache.runtimes.torchDistributedWithCache.enabled is false
    set:
      dataCache:
        enabled: true
        cacheImage:
          registry: ghcr.io
          repository: kubeflow/trainer/data-cache
          tag: ""
        runtimes:
          torchDistributedWithCache:
            enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: Should fail when torchDistributedWithCache is enabled but dataCache is disabled
    set:
      dataCache:
        enabled: false
        cacheImage:
          registry: ghcr.io
          repository: kubeflow/trainer/data-cache
          tag: "v1.0.0"
        runtimes:
          torchDistributedWithCache:
            enabled: true
    asserts:
      - failedTemplate:
          errorMessage: "dataCache.runtimes.torchDistributedWithCache.enabled requires dataCache.enabled to be true"

  - it: Should render ClusterTrainingRuntime when enabled and dataCache is enabled
    set:
      dataCache:
        enabled: true
        cacheImage:
          registry: ghcr.io
          repository: kubeflow/trainer/data-cache
          tag: "v1.0.0"
        runtimes:
          torchDistributedWithCache:
            enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ClusterTrainingRuntime
      - equal:
          path: metadata.name
          value: torch-distributed-with-cache

  - it: Should have correct framework label
    set:
      dataCache:
        enabled: true
        cacheImage:
          registry: ghcr.io
          repository: kubeflow/trainer/data-cache
          tag: "v1.0.0"
        runtimes:
          torchDistributedWithCache:
            enabled: true
    asserts:
      - equal:
          path: metadata.labels["trainer.kubeflow.org/framework"]
          value: torch

  - it: Should use correct serviceAccountName for dataset-initializer
    set:
      dataCache:
        enabled: true
        cacheImage:
          registry: ghcr.io
          repository: kubeflow/trainer/data-cache
          tag: "v1.0.0"
        runtimes:
          torchDistributedWithCache:
            enabled: true
    asserts:
      - equal:
          path: spec.template.spec.replicatedJobs[0].template.spec.template.spec.serviceAccountName
          value: kubeflow-trainer-cache-initializer

  - it: Should use custom cacheImage tag when specified
    set:
      dataCache:
        enabled: true
        cacheImage:
          registry: ghcr.io
          repository: kubeflow/trainer/data-cache
          tag: "v1.0.0"
        runtimes:
          torchDistributedWithCache:
            enabled: true
    asserts:
      - matchRegex:
          path: spec.template.spec.replicatedJobs[0].template.spec.template.spec.containers[0].env[0].value
          pattern: "ghcr.io/kubeflow/trainer/data-cache:v1.0.0"

  - it: Should have dataset-initializer depend on node job
    set:
      dataCache:
        enabled: true
        cacheImage:
          registry: ghcr.io
          repository: kubeflow/trainer/data-cache
          tag: "v1.0.0"
        runtimes:
          torchDistributedWithCache:
            enabled: true
    asserts:
      - equal:
          path: spec.template.spec.replicatedJobs[1].dependsOn[0].name
          value: dataset-initializer
      - equal:
          path: spec.template.spec.replicatedJobs[1].dependsOn[0].status
          value: Complete
