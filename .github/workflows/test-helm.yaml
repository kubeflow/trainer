---
name: Unit and Integration Test - Helm

on:
  pull_request:

jobs:
  generate:
    name: Generate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Run make generate
        run: |
          if make help 2>/dev/null | grep -q "generate"; then
            make generate
          else
            echo "No generate target found, skipping..."
          fi

      - name: Run make helm-unittest
        run: |
          if make help 2>/dev/null | grep -q "helm-unittest"; then
            make helm-unittest
          else
            echo "No helm-unittest target found, skipping..."
          fi

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: generate

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.7.0

      - name: Set up Kind
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: chart-testing
          wait: 300s

      - name: Run chart-testing (lint)
        run: |
          ct lint \
            --config .github/ct.yaml \
            --all \
            --debug

      - name: Install JobSet dependency manually
        run: |
          JOBSET_VERSION="v0.8.2"
          helm install jobset oci://registry.k8s.io/jobset/charts/jobset \
            --version $JOBSET_VERSION \
            --create-namespace \
            --namespace=jobset-system \
            --wait \
            --timeout=300s

          echo "JobSet installed successfully"
          kubectl get pods -n jobset-system

      - name: Run chart-testing (install)
        run: |
          ct install \
            --config .github/ct.yaml \
            --all \
            --debug

      - name: Verify Helm installation
        run: |
          echo "=== Cluster Status ==="
          kubectl get nodes -o wide

          echo "=== Namespaces ==="
          kubectl get namespaces

          echo "=== All Pods ==="
          kubectl get pods --all-namespaces -o wide

          echo "=== Training Operator Pods ==="
          kubectl get pods -n kubeflow-system \
            -l app.kubernetes.io/name=kubeflow-trainer || true

          echo "=== JobSet Pods ==="
          kubectl get pods -n jobset-system || true

          echo "=== Services ==="
          kubectl get svc --all-namespaces

          echo "=== CRDs ==="
          kubectl get crd | grep -E "(training|jobset)" || \
            echo "No training/jobset CRDs found"

      - name: Run basic functionality tests
        run: |
          echo "=== Testing Chart Installation ==="
          helm upgrade kubeflow-trainer charts/kubeflow-trainer \
            --install \
            --dependency-update \
            --namespace kubeflow-system \
            --create-namespace \
            --wait \
            --timeout 300s \
            --set jobset.install=false \
            --dry-run

          echo "Chart validation successful!"

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up resources..."
          kubectl delete namespace kubeflow-system \
            --ignore-not-found=true || true
          kubectl delete namespace jobset-system \
            --ignore-not-found=true || true
